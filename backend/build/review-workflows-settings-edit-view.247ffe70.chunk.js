"use strict";(self.webpackChunkgame_tavern=self.webpackChunkgame_tavern||[]).push([[4409],{28104:(Ee,M,t)=>{t.r(M),t.d(M,{default:()=>oe});var e=t(67294),i=t(80621),g=t(86706),T=t(36364),X=t(12473),h=t(96987),z=t(74863),p=t(10574),U=t(18226),y=t(41054),Y=t(36968),J=t.n(Y),G=t(86896),H=t(88767),$=t(16550),K=t(92686),Q=t(79194),b=t(75021),I=t(11984),d=t(43390),c=t(38705),q=t(68997),_=t(85230),l=t(86978),ee=t(52258),L=t(3848),te=t(66578);function se(){const{workflowId:u}=(0,$.UO)(),ne=(0,g.useSelector)(T._),{formatMessage:n}=(0,G.Z)(),E=(0,g.useDispatch)(),{put:ae}=(0,i.useFetchClient)(),{formatAPIError:le}=(0,i.useAPIErrorHandler)(),D=(0,i.useNotification)(),{isLoading:A,meta:m,workflows:k,status:W,refetch:re}=(0,ee.n)(),{collectionTypes:ie,singleTypes:ce,isLoading:fe}=(0,K.G)(),{status:ge,clientState:{currentWorkflow:{data:a,isDirty:de,hasDeletedServerStages:F}}}=(0,g.useSelector)(s=>s?.[l.sN]??L.E),{allowedActions:{canDelete:ue,canUpdate:S}}=(0,i.useRBAC)(ne.settings["review-workflows"]),[w,v]=e.useState({}),{getFeature:me,isLoading:R}=(0,b.q)(),[O,f]=e.useState(!1),[we,P]=e.useState(null),x=k.find(s=>s.id===parseInt(u,10)),V=k.filter(s=>s.id!==parseInt(u,10)).flatMap(s=>s.contentTypes),{mutateAsync:ve,isLoading:Z}=(0,H.useMutation)(async({workflow:s})=>{const{data:{data:o}}=await ae(`/admin/review-workflows/workflows/${s.id}`,{data:s});return o},{onSuccess(){D({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}}),he=async s=>{P(null);try{return await ve({workflow:s})}catch(o){return o.response.data?.error?.name==="ValidationError"&&o.response.data?.error?.details?.errors?.length>0&&P(o.response.data?.error?.details?.errors.reduce((B,N)=>(J()(B,N.path,N.message),B),{})),D({type:"warning",message:le(o)}),null}},j=async()=>{await he(a),await re(),v({})},pe=async()=>{await j()},ye=()=>{v({})},C=(0,y.useFormik)({enableReinitialize:!0,initialErrors:we,initialValues:a,async onSubmit(){const s=a.contentTypes.some(o=>V.includes(o));r?.[l.Ef]&&m?.workflowCount>parseInt(r[l.Ef],10)?f("workflow"):r?.[l._X]&&a.stages.length>parseInt(r[l._X],10)?f("stage"):F||s?(F&&v(o=>({...o,hasDeletedServerStages:!0})),s&&v(o=>({...o,hasReassignedContentTypes:!0}))):j()},validate(s){return(0,te.V)({values:s,formatMessage:n})}});(0,Q.v)(l.sN,L.I);const r=me("review-workflows");return e.useEffect(()=>(E((0,I.fC)({status:W,data:x})),()=>{E((0,I.Js)())}),[W,x,E]),e.useEffect(()=>{!A&&!R&&(r?.[l.Ef]&&m?.workflowCount>parseInt(r[l.Ef],10)?f("workflow"):r?.[l._X]&&a.stages.length>parseInt(r[l._X],10)&&f("stage"))},[a.stages.length,R,A,r,m?.workflowCount,m.workflowsTotal]),e.createElement(e.Fragment,null,e.createElement(d.lx,null),e.createElement(y.FormikProvider,{value:C},e.createElement(y.Form,{onSubmit:C.handleSubmit},e.createElement(d.h4,{navigationAction:e.createElement(d.eJ,{href:"/settings/review-workflows"}),primaryAction:S&&e.createElement(X.z,{startIcon:e.createElement(U.Z,null),type:"submit",size:"M",disabled:!de,loading:!Object.keys(w).length>0&&Z},n({id:"global.save",defaultMessage:"Save"})),subtitle:a.stages.length>0&&n({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:a.stages.length}),title:a.name}),e.createElement(d.fC,null,fe||ge==="loading"?e.createElement(h.k,{justifyContent:"center"},e.createElement(z.a,null,n({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"}))):e.createElement(h.k,{alignItems:"stretch",direction:"column",gap:7},e.createElement(_.Y,{canUpdate:S,contentTypes:{collectionTypes:ie,singleTypes:ce},currentWorkflow:a,workflows:k}),e.createElement(q.U,{canDelete:ue,canUpdate:S,stages:C.values?.stages}))))),e.createElement(i.ConfirmDialog.Root,{isConfirmButtonLoading:Z,isOpen:Object.keys(w).length>0,onToggleDialog:ye,onConfirm:pe},e.createElement(i.ConfirmDialog.Body,null,e.createElement(h.k,{direction:"column",gap:5},w.hasDeletedServerStages&&e.createElement(p.Z,{textAlign:"center",variant:"omega"},n({id:"Settings.review-workflows.page.delete.confirm.stages.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage."})),w.hasReassignedContentTypes&&e.createElement(p.Z,{textAlign:"center",variant:"omega"},n({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:V.filter(s=>a.contentTypes.includes(s)).length})),e.createElement(p.Z,{textAlign:"center",variant:"omega"},n({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"}))))),e.createElement(c.fC,{isOpen:O==="workflow",onClose:()=>f(!1)},e.createElement(c.Dx,null,n({id:"Settings.review-workflows.edit.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})),e.createElement(c.uT,null,n({id:"Settings.review-workflows.edit.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."}))),e.createElement(c.fC,{isOpen:O==="stage",onClose:()=>f(!1)},e.createElement(c.Dx,null,n({id:"Settings.review-workflows.edit.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})),e.createElement(c.uT,null,n({id:"Settings.review-workflows.edit.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."}))))}function oe(){const u=(0,g.useSelector)(T._);return e.createElement(i.CheckPagePermissions,{permissions:u.settings["review-workflows"].main},e.createElement(se,null))}}}]);
